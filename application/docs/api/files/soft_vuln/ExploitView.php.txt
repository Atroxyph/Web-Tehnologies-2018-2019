<?php

	/**
	 * @author Paul-Reftu
	 */

	require_once("Exploit.php");
	require_once("NvdCrawler.php");

	/**
	 * class whose instance represents the view part of the software vulnerability search functionality
	 */
	class ExploitView {

		private $nvdCrawler;

		private $description;
		private $currPage;
		private $noOfShownPageLinks;
		private $totalResults;
		private $resultsPerPage;

		/*
		 * the maximum no. of read characters from a property's value
		 *  (prevents the echoing of very long description or code segments of an exploit)
		 */ 
		private $maxNoOfPropReadChars;

		/**
		 * @param $description
		 * @param $currPage
		 * @param $noOfShownPageLinks
		 * @param $totalResults
		 * @param $resultsPerPage
		 * @param maxNoOfPropReadChars
		 * constructs an object of type 'ExploitView' and initializes given parameters into the object - also preparing the 'NvdCrawler' for its job
		 */
		public function __construct($description, $currPage, $noOfShownPageLinks, $totalResults, $resultsPerPage, $maxNoOfPropReadChars) {

			$this->description = $description;
			$this->currPage = $currPage;
			$this->noOfShownPageLinks = $noOfShownPageLinks;
			$this->totalResults = $totalResults;
			$this->resultsPerPage = $resultsPerPage;
			$this->maxNoOfPropReadChars = $maxNoOfPropReadChars;

			$this->nvdCrawler = new NvdCrawler(null);

		} // END of __construct()

		/**
		 * @param $exploit the exploit whose properties we ought to print
		 * prints all key-value pairs of all properties of an exploit
		 */
		public function printExploitInfo($exploitList) {

			/*
			 * start echoing the query results
			 */
			echo "<div class='searchResults'>";

			echo "<div>";
			echo "Searching for " . $this->description . "..." . "<br/>";
			echo "Found " . $this->totalResults . " matches." . "<br/><br/>";
			echo "</div>";

			$vulnIndex = 0;

			foreach ($exploitList as $exploit) {

				echo "<div>";
				echo "<h3>Exploit " . $exploit->_id . ":" . "</h3>";
				echo "<ul>";

				foreach(Exploit::getObjectPropNameList() as $propName) {

					$val = $exploit->getValueofProp($propName);

					if ($val !== null) {

						ExploitView::echoProperty($val, $propName);

						if ($propName === "cve") {

							if (is_array($val)) {

								$cve = sizeof($val) > 0 ? $this->sanitizeString($val[0]) : null;

							}
							else if (is_string($val)) {

								$cve = $this->sanitizeString($val);

							}

						}

					}

				}

				echo "<br/>";

				if (isset($_POST["getVuln" . $vulnIndex . "Refs"])) {

					if ($cve != null) {

						$this->nvdCrawler->setVulnCveId($cve);
						$refs = $this->nvdCrawler->collectRefs();

						if ($refs != null) {

							echo "Further references: " . "<br/>";

							foreach ($refs as $ref) {

								echo "<a target='_blank' style='color:aqua' href=" . $ref . ">" . $ref . "</a>" . "<br/>";

							}

						} 
						else {

							echo "No further references found." . "<br/>";

						}

					}
					else {

						echo "No further references could be obtained due to this exploit not having a CVE id.";

					}

				}
				else {

					echo "Click the following button to get more info.:" . "<br/>";

					echo "<form method='post' action='" . $_SERVER["REQUEST_URI"] . "'>";
					echo "<input type='submit' value='Get References' name='getVuln" . $vulnIndex . "Refs'/>";
					echo "</form>";

				}

				echo "</ul>";
				echo "</div>";

				$vulnIndex++;

			}

			echo "</div>";

			$this->printResPageAnchors();

		} // END of printExploitInfo()

		/**
		 * @param $s the string to sanitize
		 * @return the sanitized version of the given string
		 */
		private function sanitizeString($s) {

			return htmlspecialchars($s, ENT_QUOTES, "UTF-8");

		} // END of sanitizeString()

		/**
		 * @param $prop the property value
		 * @param $propName the property name
		 * Cross Site Scripting (XSS) - proof method that echoes given property from an exploit (e.g Author, Source etc)
		 */
		private function echoProperty($prop, $propName) {

			if (is_array($prop)) {
				foreach ($prop as $subProp) {
					echo "<li>" . $propName . ": " . $this->sanitizeString($this->extractPartialPropVal($subProp, $this->maxNoOfPropReadChars)) . "</li>";
				}
			}
			else if (is_string($prop)) {
				echo "<li>" . $propName . ": " . $this->sanitizeString($this->extractPartialPropVal($prop, $this->maxNoOfPropReadChars)) . "</li>";
			}

		} // END of echoProperty()


		/**
		 * print the links to the other results (if any exist)
		 */
		private function printResPageAnchors() {

			echo "<ul>";

			/*
			 * echo links to other pages containing further exploit results
			 */
			$currPageIndex = $this->currPage - 1;
			$lastShownPageLinkIndex = $currPageIndex + $this->noOfShownPageLinks - 1;

			$query = $_GET;
			$query["page"] = 1;
			$query = http_build_query($query);

			echo "<li><a href=" . $_SERVER["PHP_SELF"] . "?" . $query . ">" . " Page 1</a></li>";

			if ($currPageIndex > 0)
				echo "..." . "<br/>";

			for ($i = $currPageIndex + 1; $i < ceil($this->totalResults / $this->resultsPerPage); $i++) {
				if ($i === $lastShownPageLinkIndex) {
					if ($lastShownPageLinkIndex !== ceil($this->totalResults / $this->resultsPerPage) - 1) {
						echo "..." . "<br/>";
						$i = ceil($this->totalResults / $this->resultsPerPage) - 1;
					}
				}

				/*
			 	 * rebuild the GET query to change the page we are on
			  	 */
				$query = $_GET;
				$query["page"] = $i + 1;
				$query = http_build_query($query);

				echo "<li><a href=" . $_SERVER["PHP_SELF"] . "?" . $query . ">" . " Page " . ($i + 1) . "</a></li>";
			}

			echo "</ul>";

		} // END of printResPageAnchors()


		/**
		 * @param $propVal the value of a property
		 * @param $noOfCharsToExtract the no. of characters to extract from the given prop. value
		 * returns a specific number of characters from the given prop. value and appends '[...]' to the return value
		 *  in case the given prop. value is smaller than the no. of characters to extract
		 */
		private function extractPartialPropVal($propVal, $noOfCharsToExtract) {

			return (strlen($propVal) > $noOfCharsToExtract) ? 
				(substr($propVal, 0, $noOfCharsToExtract) . "[...]") :
				(substr($propVal, 0, $noOfCharsToExtract)) 
			;

		} // END of extractPartialPropVal()

	}

?>
